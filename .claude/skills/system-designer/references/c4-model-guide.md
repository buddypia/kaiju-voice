# C4モデルガイド

> Simon Brown の C4 Model に基づくシステム設計アプローチ。
> Phase 0 Discovery & Architecture では Level 1-2 のみを使用する。

---

## 1. C4モデル概要

C4モデルは、ソフトウェアアーキテクチャを **4つの抽象化レベル** で視覚化するフレームワークです。Simon Brown によって提唱され、Google Maps のズームイン/ズームアウトのように、システムを異なる粒度で理解するためのアプローチを提供します。

### 設計哲学

- **抽象化の階層**: 高レベルから低レベルへ段階的に詳細化
- **対象読者の明確化**: 各レベルには異なる対象読者がいる
- **シンプルさ**: UML の複雑さを避け、直感的な図を目指す
- **コミュニケーション優先**: 技術者以外にも伝わる表現

---

## 2. 4つのレベル

### Level 1: System Context（システムコンテキスト図）

**対象読者**: 全ステークホルダー（技術者・非技術者問わず）

**目的**: システム全体の位置づけを俯瞰する「最高レベルのズームアウト」。

**含めるべき要素**:
| 要素 | 説明 | 表記 |
|------|------|------|
| **Person** | システムを使用するユーザー/アクター | 人型アイコン |
| **Software System** | 構築対象のシステム（中心） | 大きなボックス |
| **External System** | 連携する外部システム | 破線ボックス |
| **Relationship** | 要素間の関係・データフロー | 矢印 + ラベル |

**含めないもの**:

- 内部コンポーネントの詳細
- 技術スタック
- データベーステーブル
- API エンドポイント

### Level 2: Container（コンテナ図）

**対象読者**: 技術チーム（開発者、アーキテクト）

**目的**: システム内部を「コンテナ」単位で分解する。コンテナとはデプロイ可能な独立した実行単位。

**含めるべき要素**:
| 要素 | 説明 | 例 |
|------|------|------|
| **Web Application** | フロントエンド | Flutter Web App |
| **API Application** | バックエンドAPI | Edge Functions |
| **Database** | データストア | Supabase PostgreSQL |
| **External Service** | 外部API/サービス | Google TTS, Gemini AI |
| **通信プロトコル** | コンテナ間の通信方式 | HTTPS, REST, SDK |

**含めないもの**:

- クラス/モジュールの詳細
- 個別のAPI エンドポイント
- データベーステーブルの構造

### Level 3: Component（コンポーネント図） --- Phase 0 では不使用

**対象読者**: 開発者

**目的**: 各コンテナ内部の主要コンポーネント（モジュール、サービスクラス等）を示す。

> **Phase 0 では Level 3 に踏み込まない理由**:
>
> - Phase 0 は Discovery & Architecture 段階であり、実装詳細は Phase 1 以降で決定
> - Level 2 までで十分なアーキテクチャ理解が得られる
> - 早期に Level 3 を定義すると、実装の柔軟性を損なう

### Level 4: Code（コード図） --- Phase 0 では不使用

**対象読者**: 開発者

**目的**: 個別のクラス/インターフェースレベルの詳細。UML クラス図に相当。

> Phase 0 では完全にスコープ外。

---

## 3. Hackathon Project プロジェクトでの適用

### Level 1: System Context

Hackathon Project システムのコンテキスト図では、以下の要素を配置します。

**アクター（Person）**:
| アクター | 説明 |
|---------|------|
| 学習者 (Learner) | 韓国語を学ぶエンドユーザー。Web ブラウザからアクセス |

**中心システム（Software System）**:
| システム | 説明 |
|---------|------|
| Hackathon Project | AI 駆動の韓国語学習 Web アプリケーション |

**外部システム（External System）**:
| 外部システム | 説明 | 連携内容 |
|-------------|------|---------|
| Google Cloud TTS | テキスト音声変換サービス | 韓国語テキストの音声生成 |
| Gemini AI | Google の AI モデル | コンテンツ生成、AI チュータリング、レベル評価 |
| RevenueCat | サブスクリプション管理 | 課金・プラン管理、レシート検証 |

### Level 2: Container

Hackathon Project システム内部のコンテナ構成:

| コンテナ                | 技術                   | 責務                                                |
| ----------------------- | ---------------------- | --------------------------------------------------- |
| **Flutter Web App**     | Flutter/Dart, Riverpod | UI 表示、状態管理、ユーザーインタラクション         |
| **Supabase PostgreSQL** | PostgreSQL, RLS        | ユーザーデータ、学習進捗、コンテンツ保存            |
| **Edge Functions**      | Deno/TypeScript        | AI チュータ、コンテンツ生成、TTS 連携、レベルテスト |

**コンテナ間の通信**:
| From | To | プロトコル | 説明 |
|------|----|----------|------|
| Flutter Web App | Supabase PostgreSQL | Supabase Client SDK | リアルタイムデータ取得・更新 |
| Flutter Web App | Edge Functions | HTTPS/REST | AI 処理リクエスト |
| Edge Functions | Gemini AI | Gemini API (HTTPS) | AI コンテンツ生成・チュータリング |
| Edge Functions | Google Cloud TTS | Cloud TTS API (HTTPS) | 音声生成リクエスト |
| Flutter Web App | RevenueCat | RevenueCat SDK | サブスクリプション状態確認 |

---

## 4. 良い図と悪い図の違い

### 良い図の特徴

1. **明確なタイトル**: 何の図であるかが一目で分かる
2. **適切な抽象度**: そのレベルに適した詳細度を維持
3. **ラベル付きの関係線**: 矢印に「何のデータ/リクエスト」が流れるか記載
4. **技術スタックの明記**（Level 2以降）: 各コンテナの技術を明記
5. **責務の明記**: 各要素が「何をするか」を簡潔に記述
6. **一貫した表記**: Person, System, Container 等の表記を統一

### 悪い図の特徴

1. **抽象度の混在**: Level 1 にクラス名が登場、Level 2 にテーブル定義が含まれる
2. **ラベルなしの矢印**: 何が流れているか不明
3. **要素の過多**: 一つの図に20以上の要素を詰め込む
4. **曖昧な名称**: "Service A", "Module X" のような意味のない名前
5. **責務の未定義**: ボックスだけあって何をするか分からない
6. **外部システムの省略**: 重要な外部連携が図に含まれない

### チェックリスト

図を作成した後、以下を確認:

- [ ] 対象レベルに適した抽象度になっているか
- [ ] 全ての関係線にラベルがあるか
- [ ] 全ての要素に説明文があるか
- [ ] 外部システムが漏れなく含まれているか
- [ ] 技術チーム以外にも理解できるか（Level 1 の場合）
- [ ] 一つの図の要素数が15個以下に収まっているか

---

## 5. 参考資料

- [C4 Model 公式サイト](https://c4model.com/) - Simon Brown による公式ドキュメント
- [Mermaid C4 パターン](./mermaid-c4-patterns.md) - 本プロジェクトでの Mermaid 構文ガイド
