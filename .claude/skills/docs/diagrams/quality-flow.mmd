%% å“è³ªæ¤œè¨¼ãƒ•ãƒ­ãƒ¼å›³
%% pre-quality-gate, security-scan, persistent-mode, pre-quality-gateã®çµ±åˆãƒ•ãƒ­ãƒ¼

flowchart TB
    %% é–‹å§‹
    Start([å®Ÿè£…å®Œäº†])

    %% Pre-Quality Gate
    subgraph PreQuality["Pre-Quality Gate"]
        PQG[pre-quality-gate]

        PQ1[Makefile q.check å®Ÿè¡Œ]
        PQ2[çµæœãƒ‘ãƒ¼ã‚¹]
        PQ3{é€šé?}

        PQG --> PQ1 --> PQ2 --> PQ3
    end

    %% Quality Gate ã‚µã‚¤ã‚¯ãƒ«
    subgraph QualityGate["Quality Gate ã‚µã‚¤ã‚¯ãƒ« (ESP v3.1)"]
        FQA[pre-quality-gate]

        %% Pre-flight
        PreFlight1[/"âœˆï¸ Pre-flight Checklist"/]
        PF1[Node.js ç¢ºèª]
        PF2[ç›®æ¨™ã‚¿ã‚¤ãƒ—ç¢ºèª]
        PF3[Evidence ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª]

        %% ã‚µã‚¤ã‚¯ãƒ«
        Cycle["Cycle N/5"]
        C1[Step 1: ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯]
        C2[Step 2: é™çš„è§£æ]
        C3[Step 3: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ]
        C4{ã™ã¹ã¦é€šé?}

        %% è‡ªå‹•ä¿®æ­£
        AutoFix[è‡ªå‹•ä¿®æ­£]
        AF1[unused_import å‰Šé™¤]
        AF2[const è¿½åŠ ]
        AF3[ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼åˆ†æ]

        %% Post-flight
        PostFlight1[/"ğŸ›¬ Post-flight Checklist"/]
        POF1[ç›®æ¨™æ¤œæŸ»é€šé]
        POF2[è‡ªå‹•ä¿®æ­£å®Œäº†]
        POF3[Evidence ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°]

        FQA --> PreFlight1
        PreFlight1 --> PF1 --> PF2 --> PF3
        PF3 --> Cycle

        Cycle --> C1 --> C2 --> C3 --> C4
        C4 -->|No| AutoFix
        AutoFix --> AF1 --> AF2 --> AF3
        AF3 --> Cycle

        C4 -->|Yes| PostFlight1
        PostFlight1 --> POF1 --> POF2 --> POF3
    end

    %% Security Scan
    subgraph SecurityScan["Security Scan (ESP v2.1)"]
        SS[security-scan]

        %% Pre-flight
        PreFlight2[/"âœˆï¸ Pre-flight Checklist"/]
        SP1[æ¤œæŸ»å¯¾è±¡ç¢ºå®š]
        SP2[ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½]
        SP3[å‰å›ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª]

        %% æ¤œæŸ»
        Scan[ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œæŸ»å®Ÿè¡Œ]
        S1[Supabase RLS æ¤œæŸ»]
        S2[ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œæŸ»]
        S3[Edge Function æ¤œæŸ»]
        S4[Web ã‚¢ãƒ—ãƒªæ¤œæŸ»]

        %% çµæœ
        Report[ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ]
        R1{Critical/High<br/>ç™ºè¦‹?}

        %% Post-flight
        PostFlight2[/"ğŸ›¬ Post-flight Checklist"/]
        SOP1[ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›å®Œäº†]
        SOP2[Critical/High 0ä»¶ç¢ºèª]
        SOP3[æ¤œæŸ»çµæœã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°]

        SS --> PreFlight2
        PreFlight2 --> SP1 --> SP2 --> SP3
        SP3 --> Scan

        Scan --> S1 --> S2 --> S3 --> S4
        S4 --> Report --> R1

        R1 -->|No| PostFlight2
        PostFlight2 --> SOP1 --> SOP2 --> SOP3
    end

    %% Persistent Mode
    subgraph PersistentMode["Persistent Mode (ESP v3.1)"]
        PM[persistent-mode]

        %% Pre-flight
        PreFlight3[/"âœˆï¸ Pre-flight Checklist"/]
        PP1[æ¤œè¨¼å¯¾è±¡æ˜ç¢º]
        PP2[å®Œäº†æ¡ä»¶å®šç¾©]
        PP3[æœ€å¤§ç¹°ã‚Šè¿”ã—å›æ•°]

        %% ç¹°ã‚Šè¿”ã—ãƒ«ãƒ¼ãƒ—
        Loop["ç¹°ã‚Šè¿”ã— N/5"]
        L1[æ¤œè¨¼å®Ÿè¡Œ]
        L2{é€šé?}
        L3[åˆ†æ + ä¿®æ­£]
        L4{åŒä¸€ã‚¨ãƒ©ãƒ¼<br/>3å›?}

        %% Post-flight
        PostFlight3[/"ğŸ›¬ Post-flight Checklist"/]
        POP1[ã™ã¹ã¦ã®æ¤œè¨¼é€šé]
        POP2[CONTEXT.json æ›´æ–°]
        POP3[ç¹°ã‚Šè¿”ã—ãƒ­ã‚°è¨˜éŒ²]

        PM --> PreFlight3
        PreFlight3 --> PP1 --> PP2 --> PP3
        PP3 --> Loop

        Loop --> L1 --> L2
        L2 -->|No| L3 --> L4
        L4 -->|No| Loop
        L4 -->|Yes| EarlyStop([æ—©æœŸä¸­æ–­])

        L2 -->|Yes| PostFlight3
        PostFlight3 --> POP1 --> POP2 --> POP3
    end

    %% Evidence Cache
    subgraph EvidenceCache["Evidence Cache"]
        EC[(evidence_cache)]

        E1[npm run lint: 30åˆ†]
        E2[npm test: 30åˆ†]
        E3[security-scan: 60åˆ†]

        EC --- E1
        EC --- E2
        EC --- E3
    end

    %% æ¥ç¶š
    Start --> PreQuality

    PQ3 -->|No| FixRequired([ä¿®æ­£å¿…è¦])
    PQ3 -->|Yes| QualityGate

    POF3 --> SecurityScan

    R1 -->|Yes| Blocked([ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ–ãƒ­ãƒƒã‚¯])
    SOP3 --> PersistentMode

    POP3 --> Done([å“è³ªæ¤œè¨¼å®Œäº†])

    %% Evidence æ¥ç¶š
    PF3 -.-> EC
    SP3 -.-> EC
    POF3 -.-> EC
    SOP3 -.-> EC

    %% ã‚¹ã‚¿ã‚¤ãƒ«
    classDef preflight fill:#bbdefb,stroke:#1565c0
    classDef postflight fill:#c8e6c9,stroke:#2e7d32
    classDef decision fill:#fff3e0,stroke:#e65100
    classDef skill fill:#ffcdd2,stroke:#b71c1c
    classDef cache fill:#f3e5f5,stroke:#7b1fa2
    classDef blocked fill:#ffcdd2,stroke:#b71c1c,stroke-width:2px

    class PreFlight1,PreFlight2,PreFlight3 preflight
    class PostFlight1,PostFlight2,PostFlight3 postflight
    class PQ3,C4,R1,L2,L4 decision
    class FQA,SS,PM,PQG skill
    class EC,E1,E2,E3 cache
    class Blocked,EarlyStop,FixRequired blocked
