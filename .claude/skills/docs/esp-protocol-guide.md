# ESP (Enforced Skill Pattern) プロトコル完全ガイド

> **"強制実行プロトコルでスキル品質を保証"** - ESP v2.0/v3.0 統合文書

---

## この文書について

この文書はESP(Enforced Skill Pattern)の**すべての構成要素**を詳細に説明します。ESP適用スキルを使用または開発する際に必ず参照してください。

### 対象読者

| 読者                | 必要セクション                                                               |
| ------------------- | ---------------------------------------------------------------------------- |
| **スキル使用者**    | [ESP 概要](#esp-概要), [実行フロー](#実行フロー)                             |
| **AI エージェント** | [チェックリスト形式](#チェックリスト形式), [違反プロトコル](#違反プロトコル) |
| **スキル開発者**    | [ESP 適用方法](#esp-適用方法), [バージョン別要求事項](#バージョン別要求事項) |

---

## ESP 概要

### 一行定義

> **ESP (Enforced Skill Pattern)**はスキル実行の**品質と一貫性を強制**するプロトコルです。

### 核心構成要素

```
ESP v2.0+
├── Pre-flight Checklist (実行前検証)
├── Model Routing Policy (モデル選択強制)
├── Evidence Policy (キャッシュポリシー)
├── Post-flight Checklist (実行後検証)
└── Violation Protocol (違反時処理)
```

### なぜESPが必要か?

| 問題                   | ESP 以前           | ESP 適用後               |
| ---------------------- | ------------------ | ------------------------ |
| **チェックリスト漏れ** | 暗黙的に進行       | **明示的出力強制**       |
| **不適切なモデル使用** | コスト浪費         | **作業別最適モデル強制** |
| **不要な再検証**       | 時間浪費           | **キャッシュ活用強制**   |
| **未完了作業**         | 検証なしで完了主張 | **Post-flight 検証強制** |
| **違反放置**           | 品質低下           | **即時中断 + 再開**      |

### ESP バージョン比較

| 項目               | v1.0 (ガイド) | v2.0 (強制) |        v3.0 (強化)        |
| ------------------ | :-----------: | :---------: | :-----------------------: |
| Pre-flight         |     推奨      |  **必須**   |         **必須**          |
| Model Routing      |     なし      |  **必須**   | **必須 + フォールバック** |
| Evidence Cache     |     なし      |  **必須**   |        **自動化**         |
| Post-flight        |     推奨      |  **必須**   |         **必須**          |
| Violation Protocol |     なし      |  **必須**   |         **強化**          |

---

## ESP 適用スキル一覧

### 現在 ESP 適用スキル (6個)

| スキル                 | ESP バージョン | 主要役割                         |
| ---------------------- | :------------: | -------------------------------- |
| **feature-pilot**      |      v2.0      | 開発リクエストオーケストレーター |
| **turbo-mode**         |      v3.0      | 並列実行エンジン                 |
| **persistent-mode**    |      v3.1      | 完了まで自動継続                 |
| **pre-quality-gate**   |      v3.1      | ビルド/分析/テストサイクル       |
| **security-scan**      |      v2.1      | セキュリティ脆弱性検査           |
| **skill-health-check** |      v2.1      | スキルガバナンス監査             |

---

## 実行フロー

### ESP 全体フロー図

```
スキル呼び出し
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Pre-flight Checklist                         │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ | # | 項目 | 状態 | 備考 |                                 │ │
│  │ | 1 | 条件 1 | ✅ |      |                                 │ │
│  │ | 2 | 条件 2 | ✅ |      |                                 │ │
│  │ | 3 | 条件 3 | ⬜ |      |  ← 未充足時即時中断              │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                    │ すべて ✅
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Model Routing                                 │
│                                                                 │
│   Task 呼び出し時必ず model パラメータ明示                       │
│                                                                 │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│   │   haiku    │→ │   sonnet   │→ │    opus    │           │
│   │ (単純作業) │  │ (標準作業) │  │ (複雑作業) │           │
│   └─────────────┘  └─────────────┘  └─────────────┘           │
│                                                                 │
│   フォールバック: haiku 失敗 → sonnet → opus                    │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Evidence Policy                               │
│                                                                 │
│   検証要求時キャッシュ確認:                                      │
│   ├─ 有効なキャッシュ存在 → "[CACHE HIT]" + スキップ             │
│   └─ キャッシュなし/期限切れ → 実行 + 結果キャッシング            │
│                                                                 │
│   | 検証タイプ | 有効時間 | 無効化条件 |                          │
│   | npm run lint | 30分 | src/**/*.ts 変更 |               │
│   | npm test | 30分 | tests/**/*.ts 変更 |                 │
│   | security-scan | 60分 | infra/**, .env* 変更 |               │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    作業実行                                      │
│                                                                 │
│   スキル別核心作業を実行...                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Post-flight Checklist                        │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ | # | 項目 | 状態 | 備考 |                                 │ │
│  │ | 1 | 結果 1 | ✅ |      |                                 │ │
│  │ | 2 | 結果 2 | ✅ |      |                                 │ │
│  │ | 3 | 結果 3 | ✅ |      |  ← 未充足時再検証必要            │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                    │ すべて ✅
                    ▼
               完了報告
```

---

## チェックリスト形式

### Pre-flight Checklist テンプレート

```markdown
## ✈️ Pre-flight Checklist

|  #  | 項目             | 状態 | 備考 |
| :-: | ---------------- | :--: | ---- |
|  1  | (スキル別条件 1) |  ⬜  |      |
|  2  | (スキル別条件 2) |  ⬜  |      |
|  3  | (スキル別条件 3) |  ⬜  |      |
|  4  | (スキル別条件 4) |  ⬜  |      |
|  5  | (スキル別条件 5) |  ⬜  |      |

→ すべての項目 ✅ 確認後実行進行
→ 一つでも ❌ の場合即時中断 + 理由報告
```

### Post-flight Checklist テンプレート

```markdown
## 🛬 Post-flight Checklist

|  #  | 項目             | 状態 | 備考 |
| :-: | ---------------- | :--: | ---- |
|  1  | (スキル別結果 1) |  ⬜  |      |
|  2  | (スキル別結果 2) |  ⬜  |      |
|  3  | (スキル別結果 3) |  ⬜  |      |
|  4  | (スキル別結果 4) |  ⬜  |      |
|  5  | (スキル別結果 5) |  ⬜  |      |

→ すべての項目 ✅ で完了報告
→ 一つでも ❌ の場合修正後再検証
```

### 状態アイコン定義

| アイコン | 意味   | 動作           |
| :------: | ------ | -------------- |
|    ⬜    | 未確認 | 確認必要       |
|    ✅    | 通過   | 続行           |
|    ❌    | 失敗   | 中断または修正 |
|    ⚠️    | 警告   | 確認後続行可能 |

### Checklist Progressive Update Rule (全 ESP スキル共通)

> **⚡ CHECKLIST UPDATE RULE (MANDATORY)**:
> 各チェック項目の確認完了時に、チェックリスト全体を再出力し、該当項目の状態を更新すること。
> `⬜`/`---` → `✅` (通過) または `❌` (失敗)。全項目確認まで毎回最新状態を反映。
> **未更新のまま次段階に進行 = Violation Protocol 違反 (severity: HIGH)**

**段階的更新ルール**:

1. チェックリスト出力時、すべての項目は初期状態 (`⬜` または `---`) で出力する
2. 各項目を確認するたびに、チェックリスト**全体**を再出力し、確認済み項目の状態を `✅` または `❌` に更新する
3. すべての項目が `✅` になるまで、毎回最新状態のチェックリストを出力する
4. `❌` が 1つでもある場合、即時中断し理由を報告する

**禁止パターン**:

| 禁止行動                          | 理由                           | 正しい行動                    |
| --------------------------------- | ------------------------------ | ----------------------------- |
| 全項目を一括 `✅` にする          | 各項目の個別確認が保証されない | 1項目ずつ確認し段階的に更新   |
| チェックリスト再出力を省略する    | 進捗が不可視になる             | 毎回全体を再出力              |
| `⬜`/`---` のまま次段階に進行する | 未確認項目の見落とし           | 全項目 `✅`/`❌` 確認後に進行 |

**マーカー別バリアント**:

| チェックリストタイプ | 初期状態 | 通過  | 失敗 | スキップ |
| -------------------- | -------- | ----- | ---- | -------- |
| ESP Pre/Post-flight  | `⬜`     | `✅`  | `❌` | -        |
| Pipeline Steps       | `---`    | `✅`  | `❌` | `⏭️`     |
| Task Checklists      | `[ ]`    | `[x]` | -    | -        |

---

## スキル別チェックリスト

### feature-pilot

#### Pre-flight

```markdown
## ✈️ Pre-flight Checklist

|  #  | 項目                     | 状態 | 備考           |
| :-: | ------------------------ | :--: | -------------- |
|  1  | リクエストタイプ分類完了 |  ⬜  | NEW/MODIFY/BUG |
|  2  | 既存 CONTEXT.json 確認   |  ⬜  | なければ作成   |
|  3  | パイプライン決定         |  ⬜  |                |
|  4  | 下位スキル可用性確認     |  ⬜  |                |
```

#### Post-flight

```markdown
## 🛬 Post-flight Checklist

|  #  | 項目              | 状態 | 備考             |
| :-: | ----------------- | :--: | ---------------- |
|  1  | CONTEXT.json 更新 |  ⬜  |                  |
|  2  | パイプライン完了  |  ⬜  |                  |
|  3  | 品質検証通過      |  ⬜  | pre-quality-gate |
|  4  | index.md 同期     |  ⬜  |                  |
```

### turbo-mode

#### Pre-flight

```markdown
## ✈️ Turbo Mode Pre-flight Checklist

|  #  | 項目                            | 状態 | 備考 |
| :-: | ------------------------------- | :--: | ---- |
|  1  | 作業一覧生成完了                |  ⬜  |      |
|  2  | 各作業にタイプ(Read/Write) 指定 |  ⬜  |      |
|  3  | 依存関係グラフ分析完了          |  ⬜  |      |
|  4  | バッチ構成出力完了              |  ⬜  |      |
|  5  | 各 Task に model パラメータ明示 |  ⬜  |      |
```

#### Post-flight

```markdown
## 🛬 Turbo Mode Post-flight Checklist

|  #  | 項目                               | 状態 | 備考 |
| :-: | ---------------------------------- | :--: | ---- |
|  1  | すべてのバッチ実行完了             |  ⬜  |      |
|  2  | 各 Task model パラメータ含有確認   |  ⬜  |      |
|  3  | 衝突/失敗なし確認                  |  ⬜  |      |
|  4  | 結果マージ完了                     |  ⬜  |      |
|  5  | Evidence キャッシング完了 (該当時) |  ⬜  |      |
```

### pre-quality-gate

#### Pre-flight

```markdown
## ✈️ Pre-flight Checklist

|  #  | 項目                    | 状態 | 備考                        |
| :-: | ----------------------- | :--: | --------------------------- |
|  1  | Node.js 使用可能        |  ⬜  | node --version              |
|  2  | 目標タイプ確認          |  ⬜  | --all/--lint/--test/--build |
|  3  | プロジェクトルート確認  |  ⬜  | package.json 存在           |
|  4  | Evidence キャッシュ確認 |  ⬜  | 最近の検証結果              |
|  5  | 最大サイクル設定        |  ⬜  | デフォルト 5回              |
```

#### Post-flight

```markdown
## 🛬 Post-flight Checklist

|  #  | 項目                      | 状態 | 備考                 |
| :-: | ------------------------- | :--: | -------------------- |
|  1  | 目標検査すべて通過        |  ⬜  | lint/test/build      |
|  2  | 自動修正適用完了          |  ⬜  | 修正されたファイル数 |
|  3  | サイクルログ記録          |  ⬜  | 各サイクル結果       |
|  4  | 同一エラー未反復          |  ⬜  | 3回反復なし          |
|  5  | Evidence キャッシング完了 |  ⬜  | 検証結果保存         |
```

### security-scan

#### Pre-flight

```markdown
## ✈️ Pre-flight Checklist - security-scan

|  #  | 項目                                 | 状態 | 備考                            |
| :-: | ------------------------------------ | :--: | ------------------------------- |
|  1  | 検査対象確定                         |  ⬜  | 全体/Edge Functions/RLS/Secrets |
|  2  | infra/supabase/ アクセス可能         |  ⬜  |                                 |
|  3  | 以前のセキュリティ検査キャッシュ確認 |  ⬜  | 60分有効                        |
```

#### Post-flight

```markdown
## 🛬 Post-flight Checklist - security-scan

|  #  | 項目                         | 状態 | 備考                  |
| :-: | ---------------------------- | :--: | --------------------- |
|  1  | セキュリティレポート出力完了 |  ⬜  |                       |
|  2  | Critical/High 脆弱性 0件確認 |  ⬜  | ❌ の場合デプロイ不可 |
|  3  | 検査結果キャッシング完了     |  ⬜  |                       |
```

### persistent-mode

#### Pre-flight

```markdown
## ✈️ Pre-flight Checklist

|  #  | 項目                      | 状態 | 備考                 |
| :-: | ------------------------- | :--: | -------------------- |
|  1  | 検証対象明確              |  ⬜  | 作業範囲確認         |
|  2  | 完了条件定義済み          |  ⬜  | npm run lint/test 等 |
|  3  | 最大反復回数設定          |  ⬜  | デフォルト 5回       |
|  4  | CONTEXT.json アクセス可能 |  ⬜  | 状態保存用           |
|  5  | Evidence キャッシュ確認   |  ⬜  | 最近の検証結果       |
```

#### Post-flight

```markdown
## 🛬 Post-flight Checklist

|  #  | 項目                      | 状態 | 備考              |
| :-: | ------------------------- | :--: | ----------------- |
|  1  | すべての検証通過          |  ⬜  | analyze/test/TODO |
|  2  | CONTEXT.json 更新         |  ⬜  | 完了状態記録      |
|  3  | 反復ログ記録              |  ⬜  | 失敗→修正履歴     |
|  4  | 同一エラー未発生          |  ⬜  | 3回反復なし       |
|  5  | Evidence キャッシング完了 |  ⬜  | 検証結果保存      |
```

---

## Model Routing Policy

### モデル選択基準

| 作業複雑度 | シグナル                           | 推奨モデル | コスト |
| :--------: | ---------------------------------- | :--------: | :----: |
|   **低**   | ファイル 5個以下、読み取り/検索    |   haiku    |   $    |
|  **標準**  | ファイル 6-20個、単一機能実装      |   sonnet   |   $$   |
|   **高**   | ファイル 20個+、アーキテクチャ決定 |    opus    |  $$$   |

### 作業タイプ別推奨モデル

| 作業タイプ                 |   モデル   | 根拠               |
| -------------------------- | :--------: | ------------------ |
| ファイル検索、パターン探索 | **haiku**  | 単純マッチング     |
| package.json 読み取り      | **haiku**  | パースのみ必要     |
| Hooks/Service 検索      | **haiku**  | パターンマッチング |
| DB スキーマ確認            | **haiku**  | メタデータ照会     |
| Zod Schema 生成         | **sonnet** | テンプレートベース |
| React Hooks         | **sonnet** | パターン理解必要   |
| Component 実装                | **sonnet** | React パターン   |
| テスト作成                 | **sonnet** | テストパターン理解 |
| アーキテクチャ決定         |  **opus**  | トレードオフ分析   |
| バグ根本原因               |  **opus**  | 深い推論           |
| セキュリティレビュー       |  **opus**  | 脆弱性分析         |

### フォールバック戦略

```
haiku 失敗 → sonnet 自動昇格
sonnet 失敗 → opus 自動昇格
```

### Task 呼び出し例

```markdown
✅ 正しい呼び出し:
Task(
description: "ViewModel パターン検索",
prompt: "lib/features/で ViewModel パターン検索",
subagent_type: "Explore",
model: "haiku" ← MANDATORY
)

❌ 誤った呼び出し (model 漏れ):
Task(
description: "ViewModel パターン検索",
prompt: "...",
subagent_type: "Explore"
// model 漏れ → この Task は無効、再実行必要
)
```

---

## Evidence Policy (キャッシュポリシー)

### キャッシュ有効時間

| 検証タイプ       | 有効時間 | 無効化条件                    | キャッシュキー               |
| ---------------- | :------: | ----------------------------- | ---------------------------- |
| npm run lint  |   30分   | `src/**/*.ts` 変更          | `evidence.npm_lint`   |
| npm test     |   30分   | `tests/**/*.ts` 変更         | `evidence.npm_test`      |
| npm run build    |  1時間   | `src/**`, `package.json` 変更 | `evidence.npm_build`     |
| security-scan    |   60分   | `infra/**`, `.env*` 変更      | `evidence.security_scan`     |
| パターン検索結果 |   60分   | 検索対象ファイル変更          | `evidence.search_${pattern}` |

### キャッシュ動作フロー

```
検証要求
    │
    ▼
CONTEXT.json > evidence_cache 確認
    │
    ├── 有効なキャッシュ存在
    │   │
    │   ▼
    │   "[CACHE HIT]" メッセージ出力
    │   │
    │   ▼
    │   キャッシュ結果使用 (検証スキップ)
    │
    └── キャッシュなし / 期限切れ / 無効化
        │
        ▼
        検証実行
        │
        ▼
        結果キャッシング (evidence_cacheに保存)
```

### キャッシュ保存形式 (CONTEXT.json)

```json
{
  "evidence_cache": {
    "npm_lint": {
      "status": "pass",
      "issues": 0,
      "cached_at": "2026-02-04T10:00:00+09:00",
      "valid_until": "2026-02-04T10:30:00+09:00"
    },
    "npm_test": {
      "status": "pass",
      "passed": 47,
      "failed": 0,
      "cached_at": "2026-02-04T10:00:00+09:00",
      "valid_until": "2026-02-04T10:30:00+09:00"
    }
  }
}
```

### 強制再実行

キャッシュを無視して強制的に再実行するには:

```bash
/pre-quality-gate --force
/security-scan --force
```

---

## 違反プロトコル

### 違反タイプおよび処理

| 違反タイプ              |    深刻度    | 処理                       |
| ----------------------- | :----------: | -------------------------- |
| Pre-flight 未出力       | **CRITICAL** | 即時中断、最初から再開     |
| Pre-flight 形式未遵守   |   **HIGH**   | 形式に合わせて再出力       |
| Model パラメータ漏れ    |   **HIGH**   | 該当 Task 再実行           |
| Post-flight 未検証      |   **HIGH**   | 完了報告前に検証実行       |
| 検証なしで完了主張      | **CRITICAL** | 即時中断、検証実行         |
| Evidence キャッシュ無視 |  **MEDIUM**  | 警告後続行                 |
| テスト削除で通過        | **CRITICAL** | 即時中断、作業取消         |
| Critical 発見後デプロイ | **CRITICAL** | 即時ロールバック、事故報告 |

### 深刻度別動作

|    深刻度    | 動作                               |
| :----------: | ---------------------------------- |
| **CRITICAL** | 即時中断 → 最初から再開 → 理由報告 |
|   **HIGH**   | 該当作業再実行 → 正しい形式で修正  |
|  **MEDIUM**  | 警告メッセージ出力 → 続行許可      |

### 違反報告形式

```markdown
## ⚠️ ESP 違反検知

**違反タイプ**: Pre-flight 未出力
**深刻度**: CRITICAL
**発生箇所**: turbo-mode 実行開始
**処理**: 即時中断、最初から再開

### 推奨措置

1. Pre-flight Checklist 出力
2. すべての項目確認
3. スキル再実行
```

---

## ESP 適用方法

### 新規スキルに ESP 適用する

#### 1. SKILL.md に EXECUTION PROTOCOL セクション追加

```markdown
## 🚨 EXECUTION PROTOCOL (MANDATORY)

> **CRITICAL**: このセクションは**省略不可**です。
```

#### 2. Pre-flight Checklist 定義

スキル実行前に確認すべき条件を5個以内で定義:

```markdown
### Pre-flight Checklist (実行前必須)

スキル実行前に必ず以下のチェックリストを**出力**し各項目を確認:

|  #  | 項目     | 状態 | 備考 |
| :-: | -------- | :--: | ---- |
|  1  | (条件 1) |  ⬜  |      |
|  2  | (条件 2) |  ⬜  |      |
```

#### 3. Model Routing Policy 定義

作業タイプ別推奨モデルテーブル:

```markdown
### Model Routing Policy

| 作業タイプ | モデル | 根拠   |
| ---------- | ------ | ------ |
| (作業 1)   | haiku  | (理由) |
| (作業 2)   | sonnet | (理由) |
```

#### 4. Evidence Policy 定義

キャッシュ対象と有効時間:

```markdown
### Evidence Policy

| 検証タイプ | 有効時間 | 無効化条件 |
| ---------- | :------: | ---------- |
| (検証 1)   |   30分   | (条件)     |
```

#### 5. Post-flight Checklist 定義

```markdown
### Post-flight Checklist (実行後必須)

|  #  | 項目     | 状態 | 備考 |
| :-: | -------- | :--: | ---- |
|  1  | (結果 1) |  ⬜  |      |
|  2  | (結果 2) |  ⬜  |      |
```

#### 6. Violation Protocol 定義

```markdown
### Violation Protocol

| 違反タイプ           |  深刻度  | 処理                   |
| -------------------- | :------: | ---------------------- |
| Pre-flight 未出力    | CRITICAL | 即時中断、最初から再開 |
| Model パラメータ漏れ |   HIGH   | 該当 Task 再実行       |
| Post-flight 未検証   |   HIGH   | 完了報告前に検証実行   |
```

---

## バージョン別要求事項

### ESP v2.0 要求事項

- [ ] Pre-flight Checklist 必須出力
- [ ] Post-flight Checklist 必須出力
- [ ] Model Routing Policy 定義
- [ ] Evidence Policy 定義
- [ ] Violation Protocol 定義

### ESP v3.0 追加要求事項

- [ ] Model パラメータ強制 (Task 呼び出し時)
- [ ] フォールバック戦略実装
- [ ] Evidence 自動キャッシング
- [ ] 違反時自動再開

### ESP v3.1 追加要求事項

- [ ] 同一エラー 3回反復時早期中断
- [ ] 反復ログ記録
- [ ] CONTEXT.json 連動

---

## FAQ

### Q: ESP 未適用スキルもチェックリストを使用すべきですか?

**A**: 推奨しますが必須ではありません。ESP 適用スキルのみ強制されます。

### Q: キャッシュを常に無視したい場合は?

**A**: `--force` フラグを使用してください。または CONTEXT.json から該当キャッシュ項目を削除してください。

### Q: Pre-flight で失敗した場合はどうしますか?

**A**: 失敗した条件を先に解決した後、スキルを再実行してください。部分実行は許可されません。

### Q: カスタムチェック項目を追加できますか?

**A**: はい、SKILL.md のチェックリストを修正すれば可能です。ただし、核心項目は維持してください。

---

## 関連文書

| 文書                                                | 内容                   |
| --------------------------------------------------- | ---------------------- |
| [スキル生態系ハブ](./README.md)                     | 全体スキルシステム概要 |
| [feature-pilot SKILL.md](../feature-pilot/SKILL.md) | ESP v2.0 例            |
| [turbo-mode SKILL.md](../turbo-mode/SKILL.md)       | ESP v3.0 例            |
| [pre-quality-gate SKILL.md](../pre-quality-gate/SKILL.md)       | ESP v3.1 例            |
| [CLAUDE.md](/CLAUDE.md)                             | プロジェクト全体指針   |

---

## バージョン情報

| 項目                   | 値           |
| ---------------------- | ------------ |
| **文書バージョン**     | 1.0.0        |
| **ESP 最新バージョン** | v3.1         |
| **最終更新**           | 2026-02-04   |
| **作成者**             | AI Assistant |
