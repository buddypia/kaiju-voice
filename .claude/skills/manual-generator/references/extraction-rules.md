# Extraction Rules: ソース → マニュアル マッピング

> 各ソースファイルからマニュアルのどのセクションにデータがマッピングされるかを定義

## スキル マニュアル マッピング

### MANIFEST.json → マニュアル セクション

| MANIFEST フィールド           | マニュアル セクション                  | マッピング規則                                         |
| ----------------------------- | -------------------------------------- | ------------------------------------------------------ |
| `skill_id`                    | frontmatter.target                     | そのまま使用                                           |
| `skill_version`               | frontmatter.target_version             | そのまま使用                                           |
| `tier`                        | 1. 概要 > Tier 分類                    | 1=オーケストレーター, 2=パイプライン, 3=ユーティリティ |
| `description`                 | 1. 概要 > このスキルの機能             | そのまま使用                                           |
| `enforced_protocol`           | 1. 概要 > Tier 分類 > ESP 適用         | Yes/No                                                 |
| `model_routing.default_model` | 1. 概要 > モデルラウティング           | そのまま使用                                           |
| `model_routing.task_specific` | 3. 動作原理 > モデルラウティング       | Phase別マッピング                                      |
| `public_api.trigger_keywords` | 2. クイックスタート > Magic Keywords   | リストに変換                                           |
| `public_api.args_pattern`     | 2. クイックスタート > 主要サブコマンド | テーブルに変換                                         |
| `calls`                       | 4. リファレンス > 依存性 (calls)       | テーブルに変換                                         |
| `called_by`                   | 4. リファレンス > 依存性 (called_by)   | テーブルに変換                                         |
| `outputs`                     | 4. リファレンス > 出力 (Artifacts)     | テーブルに変換                                         |

### SKILL.md → マニュアル セクション

| SKILL.md セクション           | マニュアル セクション            | マッピング規則       |
| ----------------------------- | -------------------------------- | -------------------- |
| 最初の `>` ブロック           | タイトル下の一行説明             | そのまま使用         |
| `## 概要` / 最初の段落        | 1. 概要 > このスキルの機能       | 要約                 |
| ワークフロー/段階ダイアグラム | 3. 動作原理 > ワークフロー       | コードブロックに変換 |
| `## Pre-flight`               | 2. クイックスタート (参照リンク) | 要約のみ含む         |
| `## Post-flight`              | 4. リファレンス (参照リンク)     | 要約のみ含む         |
| 例示 (`<example>`)            | 5. プレイブック > シナリオ       | 構造化               |
| 制約事項/禁止事項             | 6. 注意事項 & 落とし穴           | テーブルに変換       |
| 呼び出し関係説明              | 7. 関連項目マップ                | ダイアグラムに変換   |

### MANIFEST 未保有スキル (18個) 処理

MANIFEST.jsonが無いスキルの場合:

- `target_version`: "N/A"と表記
- `tier`: SKILL.md 内容から推論 (オーケストレーター役割 → 1, パイプライン段階 → 2, 補助ツール → 3)
- `model_routing`: SKILL.md に明示されている場合使用、無ければ "sonnet (default)"
- `trigger_keywords`: SKILL.md の例示から抽出
- `calls`/`called_by`: SKILL.md の関係説明から抽出

## エージェント マニュアル マッピング

### Agent .md → マニュアル セクション

| Agent .md セクション | マニュアル セクション                         | マッピング規則     |
| -------------------- | --------------------------------------------- | ------------------ |
| 最初の行の説明       | 1. 概要 > このエージェントの機能              | 要約               |
| `Tools:` リスト      | 3. ファイル所有権 & 制限 > アクセス可能ツール | テーブルに変換     |
| トリガー例示         | 2. クイックスタート > トリガー方法            | リストに変換       |
| ワークフロー説明     | 4. 実行プロトコル > ワークフロー              | ダイアグラムに変換 |
| 制約/注意事項        | 5. 注意事項                                   | テーブルに変換     |

### tool-usage-guide.md で補強

| tool-usage-guide 情報 | マニュアル セクション | マッピング規則                  |
| --------------------- | --------------------- | ------------------------------- |
| 一行説明              | 1. 概要 補強          | SKILL.md 説明が不足している場合 |
| シナリオ ワークフロー | 5. プレイブック 補強  | パイプライン内の役割明確化      |
| カテゴリ分類          | 7. 関連項目マップ     | 同じカテゴリのツール連結        |

## パイプライン マニュアル マッピング

### ソース → マニュアル セクション

| ソース                       | マニュアル セクション | マッピング規則       |
| ---------------------------- | --------------------- | -------------------- |
| オーケストレーター SKILL.md  | 1. パイプライン概要   | 全体目的抽出         |
| 各参加ツール SKILL.md        | 3. Stage別詳細        | 役割/入出力抽出      |
| MANIFEST.json の calls 関係  | 2. 全体フロー         | 順序決定             |
| MANIFEST.json の outputs     | 4. Bridge Artifacts   | 成果物形式マッピング |
| tool-usage-guide.md シナリオ | 5. 実行シナリオ       | シナリオ構造化       |

## Staleness Hash 計算規則

### スキル

```
入力 = SKILL.md 全体内容 + MANIFEST.json 全体内容 (ある場合)
hash = SHA256(入力)
```

### エージェント

```
入力 = agent .md 全体内容
hash = SHA256(入力)
```

### パイプライン

```
入力 = 全参加ツールの SKILL.md 内容連結 (アルファベット順)
hash = SHA256(入力)
```

## 手動補強領域の識別

マニュアルを更新する際、以下のパターンで手動補強領域を識別します:

1. **frontmatter 外の最初の自動生成不可内容**: 実践経験ベースのプレイブック
2. **`<!-- manual-addition -->` マーカー**: 明示的な手動追加領域
3. **変更履歴中の手動項目**: "手動追加" タグがある項目

更新時にこの領域は保存し、残りの自動生成領域のみ上書きします。
