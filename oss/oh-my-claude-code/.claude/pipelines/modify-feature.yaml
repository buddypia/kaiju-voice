# Pipeline as Code: MODIFY_FEATURE
# 既存機能の修正パイプライン

name: MODIFY_FEATURE
version: 1.0.0
description: '既存SPEC差分分析 → 変更履歴追加 → 差分実装 → 検証'

tiers:
  S:
    - spec_update
    - ui_approval
    - readiness_gate
    - implement
    - quality_gate
    - dod_verification
  M:
    - spec_update
    - impact_analysis
    - ui_approval
    - readiness_gate
    - implement
    - wiring
    - status_sync
    - quality_gate
    - dod_verification
  L:
    - spec_update
    - impact_analysis
    - ui_approval
    - readiness_gate
    - implement
    - wiring
    - status_sync
    - priority_calc
    - quality_gate
    - dod_verification

steps:
  spec_update:
    skill: feature-spec-updater
    model: sonnet
    description: '既存 SPEC の差分分析・変更履歴追加'
    outputs:
      - 'SPEC.md（差分更新）'
      - '変更履歴セクション'
    compensation:
      action: 'SPEC 変更をロールバックし、要件を再確認'
      revert_to: spec_update

  impact_analysis:
    description: '変更の連鎖影響を確認（依存機能・共有コンポーネント）'
    model: sonnet
    outputs:
      - '影響範囲レポート'
    checks:
      - '依存機能への破壊的変更がないか'
      - '共有コンポーネントへの影響確認'
    compensation:
      action: '影響範囲に基づいて SPEC 変更を調整'
      revert_to: spec_update

  ui_approval:
    skill: ui-approval-gate
    model: sonnet
    type: gate
    requires_user: true
    description: 'UI変更の視覚的プレビュー（SVG + ASCII UI Before/After）+ ユーザー承認'
    compensation:
      action: 'ワイヤーフレームを修正し、再承認を依頼'
      revert_to: ui_approval

  readiness_gate:
    type: gate
    model: sonnet
    checks:
      - schema_validation
      - upstream_contract
      - change_impact_safety
      - ui_flow_contract
    compensation:
      action: 'Gate 失敗項目に対応する SPEC セクションを修正'
      revert_to: spec_update

  implement:
    skill: feature-implementer
    model: sonnet
    scope: 'modified_frs_only'
    description: '修正された FR 基準でのみ実装（既存コードは保持）'
    tdd: true
    compensation:
      action: '変更部分のみロールバックし、再実装'
      revert_to: implement

  wiring:
    skill: feature-wiring
    model: sonnet
    conditional: true
    description: 'データソース/ナビゲーション変更がある場合のみ実行'
    items:
      - 'データソース連動（API Layer → Backend）'
      - 'Next.js App Router 連動'
      - 'UI Flow Graph 更新・検証'
    compensation:
      action: '連動変更をロールバックし、再実行'
      revert_to: wiring

  status_sync:
    skill: feature-status-sync
    model: haiku

  priority_calc:
    skill: priority-analyzer
    model: haiku
    optional: true

  quality_gate:
    skill: pre-quality-gate
    type: gate
    checks:
      - lint_analyze
      - test
      - architecture_check
    retry:
      max: 3
      auto_fix: true
    compensation:
      action: 'make q.fix 実行後、再検証'
      revert_to: quality_gate

  dod_verification:
    type: gate
    model: sonnet
    description: 'BRIEF §7 完了契約検証 + CONTEXT.json completion_contract 更新'
    checks:
      - machine_items_via_evidence_cache
      - ai_items_via_code_scan
      - human_items_via_user_prompt
    inputs:
      - 'BRIEF.md §7'
      - 'CONTEXT.json completion_contract'
    outputs:
      - 'CONTEXT.json completion_contract 更新'
    compensation:
      action: '失敗 DoD 項目を特定し、修正サイクルへ'
      revert_to: implement

# Base DoD (作業タイプ別共通完了条件)
base_dod:
  MODIFY_FEATURE:
    - {
        id: DoD-FT-01,
        level: feature,
        description: '修正 FR の DoD 通過',
        type: machine,
        observation: 'progress.details で修正 FR が completed',
      }
    - {
        id: DoD-FT-02,
        level: feature,
        description: 'make q.check Critical 全通過',
        type: machine,
        observation: 'make q.check exit 0',
      }
    - {
        id: DoD-FT-03,
        level: feature,
        description: '変更履歴更新 (SPEC §5 Change Log)',
        type: ai,
        observation: 'AI が SPEC 変更履歴セクションの更新を確認',
      }
    - {
        id: DoD-FT-04,
        level: feature,
        description: 'Feature-First 依存関係ルール準拠',
        type: machine,
        observation: 'make q.check-architecture exit 0',
      }
    - {
        id: DoD-FT-05,
        level: feature,
        description: '変更ファイルに対応するテスト更新',
        type: machine,
        observation: 'make q.test-exists exit 0',
      }
    - {
        id: DoD-FT-06,
        level: feature,
        description: 'TypeScript strict エラーなし',
        type: machine,
        observation: 'npm run build exit 0',
      }
    - {
        id: DoD-FT-07,
        level: feature,
        description: '非破壊的変更 (既存 API 互換性)',
        type: ai,
        observation: 'AI が export 変更の後方互換性を検証',
      }
    - {
        id: DoD-FT-08,
        level: feature,
        description: 'CONTEXT.json current_state = Done',
        type: machine,
        observation: 'CONTEXT.json 読取で確認',
      }

global:
  evidence_caching: true
  evidence_cache_path: '.claude/state/evidence-cache.json'
  pipeline_log_path: 'docs/pipeline-log/'
  context_json_ssot: true
  max_total_retries: 8
  model_fallback:
    enabled: true
    order: [haiku, sonnet, opus]
    max_failures_before_escalation: 3
